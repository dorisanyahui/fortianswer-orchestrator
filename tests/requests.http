

## Global variables

@baseUrl = func-fortianswer-gccvakhgayenbdak.canadacentral-01.azurewebsites.net
@contentType = application/json

# Optional: set a client correlation id (the server will echo it back as x-client-correlation-id)

@clientCid = ui-test-001

# NOTE:

# - The server generates requestId. Do NOT send "requestId" in the body (it will be ignored).

# - Step2 token expires (default 5 minutes) and is bound to the exact "message" text.

---

1. Health check

---

### Health - GET

GET {{baseUrl}}/api/health

---

2. Chat - Public (Step 1): likely needs web confirmation

---

### Public Step1 - expect needsWebConfirmation=true + webSearchToken

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}
x-correlation-id: {{clientCid}}

{
"message": "Explain CVE-2024-3094 (xz backdoor) impact and mitigations, with a short timeline.",
"requestType": "Public",
"conversationId": "conv-public-001",
"userRole": "User"
}

# EXPECT:

# - 200 OK

# - needsWebConfirmation: true

# - webSearchToken: non-null

# - requestId: server GUID

# - actionHints includes: next:ask_user_for_web_search

---

3. Chat - Public (Step 2): confirm web search

---

### Public Step2 - confirm (PASTE token from Step1)

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}
x-correlation-id: {{clientCid}}

{
"message": "Explain CVE-2024-3094 (xz backdoor) impact and mitigations, with a short timeline.",
"requestType": "Public",
"conversationId": "conv-public-001",
"confirmWebSearch": true,
"webSearchToken": "{{PASTE_WEBSEARCH_TOKEN_FROM_STEP1}}"
}

# EXPECT:

# - 200 OK

# - needsWebConfirmation: false

# - actionHints includes: used:web_search

# - citations includes web sources

# - if internal lowOverlap/weakEvidence => internal citations filtered

---

4. Chat - Internal (no web search allowed)

---

### Internal - should NOT ask for web search (web disabled by policy)

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}
x-correlation-id: {{clientCid}}

{
"message": "What is the retention period for FortiAnswer PDFs and archives?",
"requestType": "Internal",
"conversationId": "conv-internal-001",
"userRole": "User"
}

# EXPECT:

# - 200 OK

# - needsWebConfirmation: false

# - citations likely from internal documents (if present)

# - actionHints includes used:internal_search

---

5. Chat - Public but web search disabled by config

---

### Public - web disabled scenario (only meaningful if WEBSEARCH_MODE != tavily or no key configured)

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}

{
"message": "What happened in the most recent Microsoft outage?",
"requestType": "Public",
"conversationId": "conv-public-web-off-001"
}

# EXPECT (if web not enabled):

# - 200 OK

# - needsWebConfirmation may be false

# - actionHints may include: web_disabled_or_not_allowed

---

6. Validation - Missing body

---

### Missing Body - expect 400 MissingBody

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}

---

7. Validation - Invalid JSON

---

### Invalid JSON - expect 400 InvalidJson

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}

{
"message": "hello",
"requestType": "Public",

---

8. Validation - Missing message

---

### Missing message - expect 400 ValidationError

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}

{
"requestType": "Public"
}

---

9. Public Step2 - confirmWebSearch=true but missing token

---

### Step2 missing token - expect 400 ValidationError webSearchToken required

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}

{
"message": "Explain CVE-2024-3094 (xz backdoor) impact and mitigations, with a short timeline.",
"requestType": "Public",
"confirmWebSearch": true
}

---

10. Public Step2 - invalid token (wrong token string)

---

### Step2 invalid token - expect 400 Invalid or expired webSearchToken

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}

{
"message": "Explain CVE-2024-3094 (xz backdoor) impact and mitigations, with a short timeline.",
"requestType": "Public",
"confirmWebSearch": true,
"webSearchToken": "this-is-not-a-valid-token"
}

---

11. Public Step2 - token for one message used with different message (message mismatch)

---

### Step2 mismatch message - expect 400 Invalid or expired webSearchToken

# Paste a real token from a Step1 run, then change the message slightly to trigger mismatch

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}

{
"message": "Explain CVE-2024-3094 (xz backdoor) impact and mitigations with a short timeline.",
"requestType": "Public",
"confirmWebSearch": true,
"webSearchToken": "{{PASTE_WEBSEARCH_TOKEN_FROM_STEP1}}"
}

# NOTE: even removing a comma can cause mismatch because token binds to sha256(message).

---

12. Public Step2 - token expired test

---

### Step2 expired token - expect 400 Invalid or expired webSearchToken

# Steps:

# 1) Run Public Step1 to get token

# 2) Wait longer than token TTL (default 5 minutes)

# 3) Run this request

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}

{
"message": "Explain CVE-2024-3094 (xz backdoor) impact and mitigations, with a short timeline.",
"requestType": "Public",
"confirmWebSearch": true,
"webSearchToken": "{{PASTE_EXPIRED_TOKEN_HERE}}"
}

---

13. Internal retrieval “off-topic” filtering behavior (demonstration)

---

### Off-topic filter demo - ask a public security question but expect internal docs to be irrelevant

### Step1 should show internal:lowOverlap=true and internal:citations_filtered=true

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}

{
"message": "Summarize the impact of the XZ backdoor on SSH servers and list mitigations.",
"requestType": "Public",
"conversationId": "conv-filter-demo-001"
}

# EXPECT:

# - actionHints includes internal:lowOverlap=true

# - internal:citations_filtered=true

# - needsWebConfirmation likely true (if web enabled)

---

14. Public - no web needed (if internal has strong evidence)

---

### Public - if internal KB contains strong evidence on this topic, should answer without needing web

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}

{
"message": "FortiAnswer PDF retention and archive duration?",
"requestType": "Public",
"conversationId": "conv-public-no-web-001"
}

# EXPECT:

# - needsWebConfirmation: false (if internal evidence is sufficient and overlap is good)

# - citations may be internal (unless filtered)

---

15. Extra fields ignored test (client sends unknown fields)

---

### Unknown fields - should still 200 (unknown properties ignored by System.Text.Json)

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}

{
"message": "What is FortiAnalyzer?",
"requestType": "Public",
"conversationId": "conv-extra-fields-001",
"maxTokens": 250,
"temperature": 0.2,
"foo": "bar"
}

# EXPECT:

# - 200 OK

# - server ignores maxTokens/temperature/foo unless your model is extended to use them

---

16. Client correlation id echo test

---

### Client correlation id echo - server should return x-client-correlation-id header

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}
x-correlation-id: client-trace-999

{
"message": "Hello, please answer briefly: what does this service do?",
"requestType": "Public",
"conversationId": "conv-trace-001"
}

# EXPECT:

# - Response header x-correlation-id: server GUID

# - Response header x-client-correlation-id: client-trace-999

# - actionHints includes clientCorrelationId=client-trace-999

---

17. Web enabled sanity check (only if WEBSEARCH_MODE=tavily configured)

---

### Web sanity - Step1 then Step2 quickly

### Run Step1, paste token, run Step2 within 5 minutes.

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}

{
"message": "Give a short source-based timeline of CVE-2024-3094 and mitigations.",
"requestType": "Public",
"conversationId": "conv-web-sanity-001"
}

### Web sanity Step2

POST {{baseUrl}}/api/chat
Content-Type: {{contentType}}

{
"message": "Give a short source-based timeline of CVE-2024-3094 and mitigations.",
"requestType": "Public",
"conversationId": "conv-web-sanity-001",
"confirmWebSearch": true,
"webSearchToken": "{{PASTE_WEBSEARCH_TOKEN_FROM_STEP1}}"
}

---

## Notes (important)

1. Do not include "requestId" in client request body:

   * requestId is server-generated and returned in response.
   * If you include requestId in request body, it is ignored by your current ChatRequest model.

2. Step2 token is strict:

   * Must be used within token TTL (default 5 minutes).
   * Must use EXACT same message text as Step1.

3. If you want a more UI-friendly token flow:

   * Increase TTL (e.g., 15 minutes), and/or
   * Bind token to requestId instead of message (requires small code change).

If you want, paste your current IngestFunction request schema, and I will add a full “/api/ingest test pack” section too (success + validation + auth failure cases).
